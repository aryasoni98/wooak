name: Hacktoberfest

on:
  issues:
    types: [opened, labeled, closed]
  pull_request:
    types: [opened, labeled, closed, merged]
  pull_request_target:
    types: [opened, labeled, closed, merged]

permissions:
  issues: write
  pull-requests: write
  contents: read

jobs:
  hacktoberfest-check:
    runs-on: ubuntu-latest
    if: |
      ((github.event_name == 'pull_request' || github.event_name == 'pull_request_target') && 
       (github.event.label.name == 'hacktoberfest' || 
        contains(github.event.pull_request.labels.*.name, 'hacktoberfest')))
    steps:
      - name: Check if PR is valid for Hacktoberfest
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GH_TOKEN }}
          script: |
            // Only run for pull request events
            if (context.eventName !== 'pull_request' && context.eventName !== 'pull_request_target') {
              console.log('Not a pull request event, skipping...');
              return;
            }

            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number
            });

            // Check if PR is not a draft
            if (pr.draft) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body: `ğŸš« **Hacktoberfest Notice**: This PR is currently in draft mode. Please mark it as "Ready for review" to be eligible for Hacktoberfest.`
              });
              return;
            }

            // Check if PR has meaningful changes
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number
            });

            const meaningfulChanges = files.some(file => 
              file.changes > 0 && 
              !file.filename.includes('package-lock.json') &&
              !file.filename.includes('yarn.lock') &&
              !file.filename.includes('.DS_Store')
            );

            if (!meaningfulChanges) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body: `âš ï¸ **Hacktoberfest Notice**: This PR appears to contain only minor changes (like whitespace or lock files). Please ensure your contribution adds meaningful value to the project.`
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body: `ğŸ‰ **Hacktoberfest**: Thank you for your contribution! This PR looks good for Hacktoberfest participation. Please ensure all CI checks pass and follow our [Contributing Guidelines](CONTRIBUTING.md).`
              });
            }

  welcome-contributor:
    runs-on: ubuntu-latest
    if: github.event.action == 'opened' && github.event.issue
    steps:
      - name: Welcome new contributors
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GH_TOKEN }}
          script: |
            const { data: issue } = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number
            });

            // Check if this is a Hacktoberfest issue
            const isHacktoberfest = issue.labels.some(label => 
              label.name.toLowerCase().includes('hacktoberfest')
            );

            if (isHacktoberfest) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.issue.number,
                body: `ğŸƒ **Welcome to Hacktoberfest!** 
                
                Thank you for your interest in contributing to Wooak! 
                
                Please make sure to:
                - ğŸ“– Read our [Contributing Guidelines](CONTRIBUTING.md)
                - ğŸ“œ Review our [Code of Conduct](CODE_OF_CONDUCT.md)
                - ğŸ¯ Check out our [good first issues](https://github.com/aryasoni98/wooak/labels/good%20first%20issue)
                
                Happy contributing! ğŸš€`
              });
            }

  pr-merged-celebration:
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'pull_request' || github.event_name == 'pull_request_target') &&
      github.event.action == 'closed' && 
      github.event.pull_request.merged
    steps:
      - name: Celebrate merged PRs
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GH_TOKEN }}
          script: |
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number
            });

            // Check if this is a Hacktoberfest PR
            const isHacktoberfest = pr.labels.some(label => 
              label.name.toLowerCase().includes('hacktoberfest')
            );

            if (isHacktoberfest) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body: `ğŸ‰ **Congratulations!** 
                
                Your Hacktoberfest contribution to **Wooak** has been merged! 
                
                Thank you for helping improve our AI-powered SSH server management tool! ğŸš€
                
                **Next Steps:**
                - ğŸŒŸ Star the repository if you found it helpful
                - ğŸ› Report any issues you encounter
                - ğŸ’¡ Suggest new features
                - ğŸ“¢ Share Wooak with others
                
                Keep contributing! ğŸƒ`
              });
            }
